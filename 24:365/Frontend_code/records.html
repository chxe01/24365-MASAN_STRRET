<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>24/365 - ê¸°ë¡</title>
    <link rel="stylesheet" href="header.css" />
    <link rel="stylesheet" href="records.css" />
    <style>
      .table-wrap table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
      }
      .table-wrap table th,
      .table-wrap table td {
        padding: 12px 14px;
      }

      .table-wrap table thead tr th:nth-child(1) {
        width: 20%; 
        text-align: left;
        padding-left: 20px;
      }
      .table-wrap table thead tr th:nth-child(2) {
        width: 60%; 
        text-align: left;
      }
      .table-wrap table thead tr th:nth-child(3) {
        width: 20%; 
        text-align: center;
      }

      .table-wrap table tbody tr td:nth-child(1) {
        text-align: left;
        padding-left: 20px;
      }
      .table-wrap table tbody tr td:nth-child(2) {
        text-align: left;
        white-space: normal;
      }
      .table-wrap table tbody tr td:nth-child(3) {
        font-weight: 600;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo" onclick="location.href='home.html'">
        <img src="logo.png" alt="ë¡œê³ " class="logo-img" />
        <span>24/365</span>
      </div>

      <nav class="nav">
        <a href="home.html">ë©”ì¸</a>
        <a href="stats.html">í†µê³„</a>
        <a href="records.html">ê¸°ë¡</a>
      </nav>

      <div class="header-right">
        <img
          src="notice.png"
          alt="ì•Œë¦¼"
          class="icon-img"
          onclick="location.href='alarm.html'"
        />
        <img
          src="setting.png"
          alt="ì„¤ì •"
          class="icon-img"
          onclick="location.href='settings.html'"
        />
        <img
          src="user.png"
          alt="ì‚¬ìš©ì"
          class="icon-img"
          onclick="location.href='user-settings.html'"
        />
      </div>
    </header>

    <main>
      <div class="records-wrapper">
        <section class="filter-bar">
          <div class="filter-title">Filter</div>
          <form id="filterForm" class="filter-controls">
            <label class="filter-field">
              <span>ë‚ ì§œ</span>
              <input type="date" id="startDate" />
            </label>

            <label class="filter-field">
              <span>ì‚°ë¶ˆ ëŒ€ì‘ ë‹¨ê³„</span>
              <select id="stageFilter">
                <option value="">ì „ì²´</option>
                <option value="1ë‹¨ê³„">1ë‹¨ê³„</option>
                <option value="2ë‹¨ê³„">2ë‹¨ê³„</option>
                <option value="3ë‹¨ê³„">3ë‹¨ê³„</option>
                <option value="ì‚°ë¶ˆ ëŒ€ì‘ ì´ˆê¸° ë‹¨ê³„">ì‚°ë¶ˆ ëŒ€ì‘ ì´ˆê¸° ë‹¨ê³„</option>
              </select>
            </label>

            <div class="filter-actions">
              <button type="submit" class="search-btn">ê²€ìƒ‰</button>
              <button type="button" id="resetFilters" class="reset-btn">
                ì´ˆê¸°í™”
              </button>
            </div>
          </form>
        </section>

        <section class="table-card">
          <div class="table-title">2025ë…„ 3ì›” ì „êµ­ ë™ì‹œë‹¤ë°œ ì‚°ë¶ˆ ì´ë ¥</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ê°ì§€ ì‹œê°</th>
                  <th>ì‚°ë¶ˆ ìœ„ì¹˜</th>
                  <th>ì‚°ë¶ˆ ëŒ€ì‘ ë‹¨ê³„</th>
                </tr>
              </thead>
              <tbody id="recordsBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>

    <div id="alert-overlay" class="alert-overlay">
      <div class="alert-box">
        <h2>ğŸ”¥ í™”ì¬ ê°ì§€ ê²½ê³ ! ğŸ”¥</h2>
        <p id="alert-message">
          AI ì„œë²„ì—ì„œ í™”ì¬(FIRE)ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤! ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!
        </p>
        <button onclick="closeAlert()">í™•ì¸ ë° ê²½ê³  ë„ê¸°</button>
      </div>
    </div>

    <script>
      (function () {
        const SERVER_HOST = "127.0.0.1";
        const SERVER_PORT = 9000;
        const WEBSOCKET_URL = `ws://${SERVER_HOST}:${SERVER_PORT}/ws/detections`;

        const alertOverlay = document.getElementById("alert-overlay");

        function startWebSocket() {
          const socket = new WebSocket(WEBSOCKET_URL);

          socket.onopen = function (e) {
            console.log("[WebSocket Open] FastAPI ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
          };

          socket.onmessage = function (event) {
            const detectionData = JSON.parse(event.data);
            console.log("ğŸ”¥ ì‹¤ì‹œê°„ ê°ì§€ ë°ì´í„° ìˆ˜ì‹ :", detectionData);

            const isFire =
              detectionData.is_fire_detected === true ||
              (detectionData.class_name &&
                detectionData.class_name.toUpperCase() === "FIRE");

            if (isFire) {
              showAlert();
            }
          };

          socket.onclose = function (event) {
            if (!event.wasClean) {
              setTimeout(startWebSocket, 5000);
            }
          };

          socket.onerror = function (error) {
            console.error("[WebSocket Error]", error);
          };
        }

        function showAlert(message) {
          document.getElementById("alert-message").textContent = message;
          alertOverlay.style.display = "flex";
        }

        window.closeAlert = function () {
          alertOverlay.style.display = "none";
        };

        window.onload = function () {
          startWebSocket();
        };
      })();

      const detectionRecords = [
        {
          timestamp: "2025-03-14 10:48",
          type: "í™”ì—¼",
          location: "ê²½ìƒë¶ë„ ì²­ë„êµ° ìš´ë¬¸ë©´ ì‹ ì›ë¦¬ ì‚° 136",
          camera: "CAM-UIS-001",
          status: "ì•Œë¦¼ ë°œì†¡",
          statusClass: "warn",
          unread: true,
          responseStage: "2ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-20 14:45",
          type: "í™”ì—¼",
          location: "ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ ê³¤ëª…ë©´ ì†¡ë¦¼ë¦¬ ì‚° 51-2",
          camera: "CAM-UIS-004",
          status: "ì˜¤íƒ",
          statusClass: "error",
          unread: false,
          responseStage: "1ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-21 15:26",
          type: "í™”ì—¼",
          location: "ê²½ìƒë‚¨ë„ ì‚°ì²­êµ° ì‹œì²œë©´ ì‹ ì²œë¦¬ ì‚°39",
          camera: "CAM-MSM-003",
          status: "ì¡°ì¹˜ ì¤‘",
          statusClass: "",
          unread: false,
          responseStage: "3ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-28 11:24",
          type: "ë¯¸í™•ì¸",
          location: "ê²½ìƒë¶ë„ ì˜ì„±êµ° ì•ˆí‰ë©´ ê´´ì‚°ë¦¬ ì‚°61",
          camera: "CAM-UIS-007",
          status: "ì¡°ì¹˜ ì¤‘",
          statusClass: "",
          unread: true,
          responseStage: "3ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-28 14:39",
          type: "ë¯¸í™•ì¸",
          location: "ê²½ìƒë¶ë„ ì˜ì„±êµ° ì•ˆê³„ë©´ ìš©ê¸°ë¦¬ 297-3",
          camera: "CAM-OKS-002",
          status: "ì•Œë¦¼ ë°œì†¡",
          statusClass: "success",
          unread: false,
          responseStage: "3ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-22 12:12",
          type: "í™”ì—¼",
          location: "ìš¸ì‚°ê´‘ì—­ì‹œ ìš¸ì£¼êµ° ì˜¨ì–‘ì ìš´í™”ë¦¬ 972-1",
          camera: "CAM-MCL-010",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "3ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-23 12:15",
          type: "ì—°ê¸°",
          location: "ê²½ìƒë‚¨ë„ í•¨ì–‘êµ° ìœ ë¦¼ë©´ ìœ í‰ë¦¬ ì‚° 105",
          camera: "CAM-BYM-005",
          status: "ì¡°ì¹˜ ì¤‘",
          statusClass: "",
          unread: false,
          responseStage: "ì‚°ë¶ˆ ëŒ€ì‘ ì´ˆê¸° ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-22 14:02",
          type: "ë¯¸í™•ì¸",
          location: "ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ í•œë¦¼ë©´ ì•ˆê³¡ë¦¬ ì‚° 106",
          camera: "CAM-BGG-006",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: true,
          responseStage: "2ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-23 11:53",
          type: "ë¯¸í™•ì¸",
          location: "ì¶©ì²­ë¶ë„ ì˜¥ì²œêµ° ì²­ì„±ë©´ ì¡°ì²œë¦¬ 740 ì¼ì›",
          camera: "CAM-UIS-001",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "2ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-23 14:05",
          type: "ì—°ê¸°",
          location: "ê²½ê¸°ë„ ë™ë‘ì²œì‹œ ìƒì—°ë™ ì‚°35-3",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "ì‚°ë¶ˆ ëŒ€ì‘ ì´ˆê¸° ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-25 11:54",
          type: "ì—°ê¸°",
          location: "ìš¸ì‚°ê´‘ì—­ì‹œ ìš¸ì£¼êµ° ì–¸ì–‘ì ì†¡ëŒ€ë¦¬ ì‚°32-1",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "2ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-25 19:15",
          type: "ì—°ê¸°",
          location: "ê²½ìƒë¶ë„ ë´‰í™”êµ° ë¬¼ì•¼ë©´ ê°œë‹¨ë¦¬ ì‚°3",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "ì‚°ë¶ˆ ëŒ€ì‘ ì´ˆê¸° ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-25 14:12",
          type: "ì—°ê¸°",
          location: "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ê³ ì°½êµ° ì„±ë‚´ë©´ ë•ì‚°ë¦¬ 44",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "1ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-25 15:45",
          type: "ì—°ê¸°",
          location: "ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ ìˆœì„±ë©´ ì‚°104-9",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "ì‚°ë¶ˆ ëŒ€ì‘ ì´ˆê¸° ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-26 19:29",
          type: "ì—°ê¸°",
          location: "ëŒ€êµ¬ê´‘ì—­ì‹œ ë‹¬ì„±êµ° ì˜¥í¬ì ê¸°ì„¸ë¦¬ ì‚°157",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "1ë‹¨ê³„",
        },
        {
          timestamp: "2025-03-26 21:22",
          type: "ì—°ê¸°",
          location: "ì „ë¶íŠ¹ë³„ìì¹˜ë„ ë¬´ì£¼êµ° ë¶€ë‚¨ë©´ ë¶€ë‚¨ë¡œ 736",
          camera: "CAM-AGM-008",
          status: "ê°ì§€ì™„ë£Œ",
          statusClass: "success",
          unread: false,
          responseStage: "2ë‹¨ê³„",
        },
      ];

      (function () {
        const recordsBody = document.getElementById("recordsBody");
        const startDateInput = document.getElementById("startDate");
        const stageFilter = document.getElementById("stageFilter");

        const filterForm = document.getElementById("filterForm");
        const resetButton = document.getElementById("resetFilters");

        if (!recordsBody || !filterForm) return;

        function filterRecords(event) {
          if (event) event.preventDefault();

          const startDateString = startDateInput.value;
          const stageValue = stageFilter.value;

          const filtered = detectionRecords.filter((record) => {
            const recordDateString = record.timestamp.split(" ")[0];

            if (startDateString && recordDateString !== startDateString) {
              return false;
            }

            if (stageValue && record.responseStage !== stageValue) {
              return false;
            }

            return true; 
          });

          renderRecords(filtered);
        }

        function renderRecords(list) {
          recordsBody.innerHTML = "";

          if (list.length === 0) {
            const emptyRow = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 3;
            cell.textContent = "ì¡°ê±´ì— ë§ëŠ” ê°ì§€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.";
            cell.style.textAlign = "center";
            cell.style.padding = "24px 0";
            emptyRow.appendChild(cell);
            recordsBody.appendChild(emptyRow);
            return;
          }

          list.forEach((record) => {
            const row = document.createElement("tr");
            row.className = record.unread ? "is-unread" : "is-read";

            row.innerHTML = `
              <td>${record.timestamp}</td>
              <td>${record.location}</td> 
              <td>${record.responseStage || "--"}</td> 
              `;
            recordsBody.appendChild(row);
          });
        }

        renderRecords(detectionRecords);

        filterForm.addEventListener("submit", filterRecords);
        resetButton.addEventListener("click", () => {
          startDateInput.value = "";
          stageFilter.value = "";
          renderRecords(detectionRecords);
        });
      })();
    </script>
  </body>
</html>
