<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>24/365</title>
    <link rel="stylesheet" href="header.css" />
    <link rel="stylesheet" href="home.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo" onclick="location.href='home.html'">
        <img src="logo.png" alt="ë¡œê³ " class="logo-img" />
        <span>24/365</span>
      </div>

      <nav class="nav">
        <a href="home.html">ë©”ì¸</a>
        <a href="stats.html">í†µê³„</a>
        <a href="records.html">ê¸°ë¡</a>
      </nav>

      <div class="header-right">
        <img
          src="notice.png"
          alt="ì•Œë¦¼"
          class="icon-img"
          onclick="location.href='alarm.html'"
        />
        <img
          src="setting.png"
          alt="ì„¤ì •"
          class="icon-img"
          onclick="location.href='settings.html'"
        />
        <img
          src="user.png"
          alt="ì‚¬ìš©ì"
          class="icon-img"
          onclick="location.href='user-settings.html'"
        />
      </div>
    </header>

    <main>
      <div class="container">
        <div class="main-content">
          <h1 class="text-3xl font-bold mb-4 text-gray-800">
            ì‹¤ì‹œê°„ ê°ì§€ ëª¨ë‹ˆí„°ë§
          </h1>
          <div class="card p-0 overflow-hidden">
            <div class="video-container" id="video-box-container">
              <div class="video-box-container">
                <img
                  id="videoFeed"
                  alt="ì‹¤ì‹œê°„ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼"
                  class="w-full h-full object-contain"
                />
                <div
                  id="bounding-box-overlay"
                  class="bounding-box-overlay"
                ></div>
              </div>
              <div
                id="videoError"
                class="absolute inset-0 bg-red-900 bg-opacity-80 flex items-center justify-center text-white text-xl font-bold hidden"
              >
                ë¹„ë””ì˜¤ í”¼ë“œ ì—°ê²° ì˜¤ë¥˜ ğŸš¨ ì„œë²„/ì¹´ë©”ë¼ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">
              ì‹œìŠ¤í…œ ìƒíƒœ
            </h2>
            <div class="flex flex-col space-y-4">
              <div
                class="flex justify-between items-center p-3 rounded-lg border"
              >
                <span class="font-medium text-gray-600">WebSocket ì—°ê²°</span>
                <span
                  id="wsStatus"
                  class="status-badge bg-yellow-100 text-yellow-800"
                  >ì—°ê²° ì¤‘...</span
                >
              </div>
              <div
                class="flex justify-between items-center p-3 rounded-lg border"
              >
                <span class="font-medium text-gray-600">AI ì„œë²„ ID</span>
                <span id="serverId" class="font-bold text-gray-800">N/A</span>
              </div>
              <div
                class="flex justify-between items-center p-3 rounded-lg border"
                id="fireStatusContainer"
              >
                <span class="font-medium text-gray-600">í™”ì¬ ê°ì§€</span>
                <span
                  id="fireStatus"
                  class="status-badge bg-green-100 text-green-800"
                  >ì •ìƒ</span
                >
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">
              ì‹¤ì‹œê°„ ê°ì§€ ë¡œê·¸
            </h2>
            <div id="detectionLog" class="log-box text-sm space-y-2">
              <p class="text-gray-500">
                FastAPI ì„œë²„ê°€ ì¼œì§€ë©´ ì‹¤ì‹œê°„ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤...
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div id="alert-overlay" class="alert-overlay">
      <div class="alert-box">
        <h2>ğŸ”¥ í™”ì¬ ê°ì§€ ê²½ê³ ! ğŸ”¥</h2>
        <p id="alert-message">
          AI ì„œë²„ì—ì„œ í™”ì¬(FIRE)ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤! ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!
        </p>
        <button onclick="closeAlert()">í™•ì¸ ë° ê²½ê³  ë„ê¸°</button>
      </div>
    </div>

    <script>
      const HOST = "127.0.0.1";
      const PORT = "9000";

      const VIDEO_FEED_URL = `http://${HOST}:${PORT}/video_feed`;
      const WEBSOCKET_URL = `ws://${HOST}:${PORT}/ws/detections`;

      const videoFeed = document.getElementById("videoFeed");
      const videoError = document.getElementById("videoError");
      const wsStatus = document.getElementById("wsStatus");
      const fireStatus = document.getElementById("fireStatus");
      const fireStatusContainer = document.getElementById(
        "fireStatusContainer"
      );
      const serverIdDisplay = document.getElementById("serverId");
      const detectionLog = document.getElementById("detectionLog");
      const alertOverlay = document.getElementById("alert-overlay");

      const overlay = document.getElementById("bounding-box-overlay");
      const videoBoxContainer = document.getElementById("video-box-container");
      const activeBoxes = {};

      let isVideoError = false;


      function handleVideoFeedError() {
        if (!isVideoError) {
          console.error(
            `ë¹„ë””ì˜¤ í”¼ë“œ URLì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${VIDEO_FEED_URL}`
          );
          videoError.classList.remove("hidden");
          fireStatusContainer.classList.add("fire-alert");
          updateStatus(fireStatus, "ğŸš¨ ì˜¤ë¥˜", "bg-red-500 text-white");
          isVideoError = true;
        }
      }

      videoFeed.onerror = handleVideoFeedError;
      videoFeed.onload = () => {
        if (isVideoError) {
          videoError.classList.add("hidden");
          fireStatusContainer.classList.remove("fire-alert");
          isVideoError = false;
        }
      };

      videoFeed.src = VIDEO_FEED_URL;


      function updateStatus(element, text, classes) {
        element.textContent = text;
        element.className = "status-badge " + classes;
      }

      function logDetection(data) {
        const confidence = data.confidence || 0;
        const now = new Date();
        const timeString = now.toLocaleTimeString("ko-KR");

        const logItem = document.createElement("p");
        logItem.classList.add("p-1", "rounded", "font-medium");

        const classNameUpper = data.class_name
          ? data.class_name.toUpperCase()
          : "";
        const isFire =
          data.is_fire_detected === true || classNameUpper === "FIRE";
        const isSmoke =
          data.is_smoke_detected === true || classNameUpper === "SMOKE";

        let logText = "";

        if (isFire) {
          logText = `[${timeString}] ë¶ˆ (${(confidence * 100).toFixed(
            1
          )}%) ğŸ”¥ (ê²½ë³´)`;
          logItem.style.backgroundColor = "#fca5a5"; 
          logItem.style.color = "#7f1d1d"; 
        } else if (isSmoke) {
          logText = `[${timeString}] ì—°ê¸° (${(confidence * 100).toFixed(
            1
          )}%) ğŸ’¨ (ì£¼ì˜)`;
          logItem.style.backgroundColor = "#fdba74"; 
          logItem.style.color = "#7c2d12"; 
        } else {
          const className = data.class_name || "ê¸ˆì„±ì‚°";
          logText = `[${timeString}] AI ê°ì§€: ${className.toUpperCase()} (${(
            confidence * 100
          ).toFixed(1)}%)`;
          logItem.style.backgroundColor = "#e5e7eb"; 
          logItem.style.color = "#1f2937"; 
        }

        logItem.textContent = logText;

        if (
          detectionLog.firstChild &&
          detectionLog.firstChild.tagName === "P" &&
          detectionLog.firstChild.textContent.includes("FastAPI ì„œë²„")
        ) {
          detectionLog.removeChild(detectionLog.firstChild);
        }
        detectionLog.prepend(logItem);

        while (detectionLog.childElementCount > 50) {
          detectionLog.removeChild(detectionLog.lastChild);
        }
      }

      function updateFireStatus(isFire, isSmoke) {
        if (isVideoError) return;

        if (isFire) {
          updateStatus(
            fireStatus,
            "ğŸ”¥ í™”ì¬ ê°ì§€!!",
            "bg-red-600 text-white fire-alert"
          );
          fireStatusContainer.classList.add("fire-alert");
        } else if (isSmoke) {
          updateStatus(fireStatus, "ğŸ’¨ ì—°ê¸° ì£¼ì˜", "bg-orange-400 text-white");
          fireStatusContainer.classList.remove("fire-alert");
        } else {
          updateStatus(fireStatus, "ì •ìƒ", "bg-green-500 text-white");
          fireStatusContainer.classList.remove("fire-alert");
        }
      }

      function showAlert(message) {
        document.getElementById("alert-message").textContent = message;
        alertOverlay.style.display = "flex";
      }

      window.closeAlert = function () {
        alertOverlay.style.display = "none";
      };

      
      function drawBoundingBox(data) {

        const location_x = parseFloat(data.location_x);
        const location_y = parseFloat(data.location_y);
        const box_w = parseFloat(data.box_width); 
        const box_h = parseFloat(data.box_height);
        const class_name = (data.class_name || "UNKNOWN").toUpperCase();
        const confidence = data.confidence;

      
        if (box_w === 0 || box_h === 0 || isNaN(box_w) || isNaN(box_h)) {
  
          overlay.innerHTML = "";
          Object.keys(activeBoxes).forEach((key) => delete activeBoxes[key]);
          return;
        }

      
        if (isNaN(location_x) || isNaN(location_y)) {
          console.error(
            `[BOX DEBUG ERROR] Received data contains NaN after parsing! Check server output for non-numeric coordinates:`,
            data
          );
          return;
        }


        const videoRect = videoFeed.getBoundingClientRect();
        const videoContainerRect = videoBoxContainer.getBoundingClientRect();

        const width = videoRect.width;
        const height = videoRect.height;


        if (width === 0 || height === 0) {
          return;
        }


        const pixelW = box_w * width;
        const pixelH = box_h * height;


        const xOffset = videoRect.left - videoContainerRect.left;
        const yOffset = videoRect.top - videoContainerRect.top;


        const pixelX = location_x * width - pixelW / 2 + xOffset;
        const pixelY = location_y * height - pixelH / 2 + yOffset;

        if (pixelW <= 0 || pixelH <= 0) {
          return;
        }


        const boxId = "box-" + class_name;
        let boxElement = activeBoxes[boxId];


        if (!boxElement) {
          boxElement = document.createElement("div");
          boxElement.id = boxId;
          boxElement.className = "bounding-box";
          boxElement.innerHTML = '<div class="box-label"></div>';
          overlay.appendChild(boxElement);
          activeBoxes[boxId] = boxElement;
        }


        let boxColorClass = "";
        let labelColorClass = "";
        let labelText = `${class_name} (${(confidence * 100).toFixed(0)}%)`;

        if (class_name === "FIRE") {
          boxColorClass = "border-red-500";
          labelColorClass = "bg-red-500 text-white";
        } else if (class_name === "SMOKE") {
          boxColorClass = "border-orange-400";
          labelColorClass = "bg-orange-400 text-white";
        } else {

          if (boxElement.parentNode)
            boxElement.parentNode.removeChild(boxElement);
          delete activeBoxes[boxId];
          return;
        }


        boxElement.className = "bounding-box " + boxColorClass;
        const labelElement = boxElement.querySelector(".box-label");
        labelElement.className = "box-label " + labelColorClass + " text-xs";


        Object.assign(boxElement.style, {
          left: `${pixelX}px`,
          top: `${pixelY}px`,
          width: `${pixelW}px`,
          height: `${pixelH}px`,
        });
        labelElement.textContent = labelText;


        clearTimeout(boxElement.timer);
        boxElement.timer = setTimeout(() => {
          boxElement.style.opacity = "0"; 
          setTimeout(() => {
            if (boxElement && boxElement.parentNode) {
              boxElement.parentNode.removeChild(boxElement);
              delete activeBoxes[boxId];
            }
          }, 500); 
        }, 500);

        boxElement.style.opacity = "1";
      }

      function startWebSocket() {
        updateStatus(wsStatus, "ì—°ê²° ì¤‘...", "bg-yellow-100 text-yellow-800");

        const socket = new WebSocket(WEBSOCKET_URL);

        socket.onopen = () => {
          updateStatus(wsStatus, "âœ… ì—°ê²°ë¨", "bg-green-500 text-white");
          console.log("WebSocket ì—°ê²° ì„±ê³µ!");
        };

        socket.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);

            console.log("[DATA RECEIVED]", data);

            serverIdDisplay.textContent = data.ai_server_id || "N/A";

          
            const classNameUpper = data.class_name
              ? data.class_name.toUpperCase()
              : "";
            const isFire =
              data.is_fire_detected === true || classNameUpper === "FIRE";
            const isSmoke =
              data.is_smoke_detected === true || classNameUpper === "SMOKE";

            console.log("[FIRE DETECTION CHECK]", {
              is_fire_detected: data.is_fire_detected,
              class_name: data.class_name,
              classNameUpper,
              isFire,
            });

            logDetection(data);
            updateFireStatus(isFire, isSmoke);
            drawBoundingBox(data);

            if (isFire) {
              console.log("[SHOWING ALERT] ë¶ˆ ê°ì§€ë¨!");
              showAlert(
                
              );
            }
          } catch (e) {
            console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e, event.data);
          }
        };

        socket.onclose = (event) => {
          
          if (event.code !== 1000) {
            updateStatus(
              wsStatus,
              "âŒ ì—°ê²° ëŠê¹€ (ì¬ì‹œë„ ì¤‘)",
              "bg-red-400 text-white"
            );
            console.error(
              `[WebSocket Close] ì—°ê²°ì´ ë¹„ì •ìƒì ìœ¼ë¡œ ëŠê²¼ìŠµë‹ˆë‹¤! ì½”ë“œ: ${event.code}`,
              event
            );
   
            setTimeout(startWebSocket, 3000);
          } else {
            updateStatus(wsStatus, "ì¢…ë£Œë¨", "bg-gray-400 text-white");
          }
        };

        socket.onerror = (error) => {
          console.error("[WebSocket Error]", error);
      
        };
      }



      window.onload = function () {
        startWebSocket();
      };
    </script>
  </body>
</html>
