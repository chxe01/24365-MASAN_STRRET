<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>24/365 - í†µê³„</title>
    <link rel="stylesheet" href="header.css" />
    <link rel="stylesheet" href="stats.css" />
    <style></style>
  </head>
  <body>
    <header class="header">
      <div class="logo" onclick="location.href='home.html'">
        <img src="logo.png" alt="ë¡œê³ " class="logo-img" />
        <span>24/365</span>
      </div>

      <nav class="nav">
        <a href="home.html">ë©”ì¸</a>
        <a href="stats.html">í†µê³„</a>
        <a href="records.html">ê¸°ë¡</a>
      </nav>

      <div class="header-right">
        <img
          src="notice.png"
          alt="ì•Œë¦¼"
          class="icon-img"
          onclick="location.href='alarm.html'"
        />
        <img
          src="setting.png"
          alt="ì„¤ì •"
          class="icon-img"
          onclick="location.href='settings.html'"
        />
        <img
          src="user.png"
          alt="ì‚¬ìš©ì"
          class="icon-img"
          onclick="location.href='user-settings.html'"
        />
      </div>
    </header>

    <main class="p-8 max-w-7xl mx-auto">
      <div class="stats-wrapper space-y-8">
        <section
          class="metric-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
          id="metricGrid"
        >
          <div class="metric-card fire active" data-key="fire">
            <div class="metric-title">ê°ì§€ëœ í™”ì—¼ ìˆ˜</div>
            <div class="metric-value">
              <span id="val-fire">--</span>
              <span class="small">ğŸ”¥</span>
            </div>
          </div>

          <div class="metric-card smoke active" data-key="smoke">
            <div class="metric-title">ê°ì§€ëœ ì—°ê¸° ìˆ˜</div>
            <div class="metric-value">
              <span id="val-smoke">--</span>
              <span class="small">â˜ï¸</span>
            </div>
          </div>

          <div class="metric-card cam active" data-key="cam">
            <div class="metric-title">ê°ì‹œ ì¤‘ì¸ ì›¹ìº  ìˆ˜</div>
            <div class="metric-value">
              <span id="val-cam">1</span>
              <span class="small">ğŸ“·</span>
            </div>
          </div>
        </section>

        <section class="panel-grid grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="panel">
    <div class="panel-header" id="panelAHeader">10ë…„ê°„ ì—°ë„ë³„ ì‚°ë¶ˆ ê±´ìˆ˜</div>
    
    <div class="panel-body">
      <img src="fire.jpeg" alt="10ë…„ê°„ ì—°ë„ë³„ ì‚°ë¶ˆ ê±´ìˆ˜ ê·¸ë˜í”„" style="width: 100%; height: auto; border-radius: 8px;margin-top: 30px;" />
    </div>
  </div>

  <div class="panel">
    <div class="panel-header" id="panelBHeader">10ë…„ê°„ ì›ì¸ë³„ ì‚°ë¶ˆ ê±´ìˆ˜</div>
    
    <div class="panel-body">
      <img 
  src="fire1.png" 
  alt="10ë…„ê°„ ì›ì¸ë³„ ì‚°ë¶ˆ ê±´ìˆ˜ ì°¨íŠ¸"
  style="
    width: 50%; 
    height: auto; 
    border-radius: 8px; 
    object-fit: contain;
    display: block;
    margin: 0 auto;
    margin-top: 20px;
  " 
/>
    </div>
  </div>
</section>

    <div id="alert-overlay" class="alert-overlay">
      <div class="alert-box">
        <h2>ğŸ”¥ í™”ì¬ ê°ì§€ ê²½ê³ ! ğŸ”¥</h2>
        <p id="alert-message">
          AI ì„œë²„ì—ì„œ í™”ì¬(FIRE)ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤! ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”!
        </p>
        <button onclick="closeAlert()">í™•ì¸ ë° ê²½ê³  ë„ê¸°</button>
      </div>
    </div>

    <script>
      const API_HOST = "127.0.0.1";
      const API_PORT = 9000;

      (function () {
        const WEBSOCKET_URL = `ws://${API_HOST}:${API_PORT}/ws/detections`;
        const alertOverlay = document.getElementById("alert-overlay");

        function startWebSocket() {
          const socket = new WebSocket(WEBSOCKET_URL);

          socket.onopen = function (e) {
            console.log("[WebSocket Open] âœ… FastAPI ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
          };

          socket.onmessage = function (event) {
            const detectionData = JSON.parse(event.data);
            console.log("ğŸ”¥ ì‹¤ì‹œê°„ ê°ì§€ ë°ì´í„° ìˆ˜ì‹ :", detectionData);

            const isFire =
              detectionData.is_fire_detected === true ||
              (detectionData.class_name &&
                detectionData.class_name.toUpperCase() === "FIRE");

            if (isFire) {
              showAlert(
                
              );
            }
          };

          socket.onclose = function (event) {
            console.log(
              `[WebSocket Close] âš ï¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤! ì½”ë“œ: ${event.code}. 5ì´ˆ í›„ ì¬ì‹œë„...`
            );
            if (!event.wasClean) {
              setTimeout(startWebSocket, 5000);
            }
          };

          socket.onerror = function (error) {
            console.error(
              "[WebSocket Error] ğŸš¨ ì—°ê²° ì˜¤ë¥˜ ë°œìƒ. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.",
              error
            );
            if (socket.readyState === WebSocket.OPEN) {
              socket.close();
            }
          };
        }

        function showAlert(message) {
          document.getElementById("alert-message").textContent = message;
          alertOverlay.style.display = "flex";
        }

        window.closeAlert = function () {
          alertOverlay.style.display = "none";
        };

        window.startWebSocket = startWebSocket;
      })();

      async function fetchStatistics() {
        const apiUrl = `http://${API_HOST}:${API_PORT}/get_today_counts/`;

        document.getElementById("val-fire").textContent = "...";
        document.getElementById("val-smoke").textContent = "...";

        try {
          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(
              `[HTTP Error] Status: ${response.status}. ì„œë²„ì—ì„œ ë¹„ì •ìƒì ì¸ ì‘ë‹µì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`
            );
          }

          const result = await response.json();

          if (result.status === "success") {
            const data = result.data;

            document.getElementById("val-fire").textContent =
              data.fire_count || 0;
            document.getElementById("val-smoke").textContent =
              data.smoke_count || 0;

            console.log("âœ… í†µê³„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì„±ê³µ:", data);
          } else {
            throw new Error(
              `[API Error] Message: ${
                result.message || "APIì—ì„œ ì˜¤ë¥˜ ìƒíƒœë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤."
              }`
            );
          }
        } catch (error) {
          console.error("ğŸš¨ í†µê³„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error.message);

          if (
            error instanceof TypeError &&
            error.message.includes("Failed to fetch")
          ) {
            console.error(
              "ğŸš¨ [Connection Error] FastAPI ì„œë²„ê°€ ì¼œì ¸ ìˆê³ , ì£¼ì†Œ(`http://127.0.0.1:9000`)ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”."
            );
          }

          document.getElementById("val-fire").textContent = "--";
          document.getElementById("val-smoke").textContent = "--";
        }
      }

      window.onload = function () {
        window.startWebSocket();

        fetchStatistics();

      };
    </script>
  </body>
</html>
