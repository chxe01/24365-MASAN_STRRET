<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>24/365 - 알림</title>
    <link rel="stylesheet" href="header.css" />
    <link rel="stylesheet" href="alarm.css" />
    <style></style>
  </head>
  <body class="no-scroll">
    <header class="header">
      <div class="logo">
        <img src="logo.png" alt="로고" class="logo-img" />
        <span>24/365</span>
      </div>

      <nav class="nav">
        <a href="home.html">메인</a>
        <a href="stats.html">통계</a>
        <a href="records.html">기록</a>
      </nav>

      <div class="header-right">
        <img
          src="notice.png"
          alt="알림"
          class="icon-img"
          onclick="location.href='alarm.html'"
        />
        <img
          src="setting.png"
          alt="설정"
          class="icon-img"
          onclick="location.href='settings.html'"
        />
        <img
          src="user.png"
          alt="사용자"
          class="icon-img"
          onclick="location.href='user-settings.html'"
        />
      </div>
    </header>

    <div class="container">
      <aside class="settings-sidebar">
        <div class="sidebar-title">
          <img src="notice.png" alt="알림" class="sidebar-title-icon" />
          <span>알림</span>
        </div>
        <div class="sidebar-item active" onclick="showAlarm(1)">
          🚨 긴급 경고
        </div>
        <div class="sidebar-item" onclick="showAlarm(2)">⚠️ 조치 필요</div>
        <div class="sidebar-item" onclick="showAlarm(3)">✅ 해결 완료</div>
      </aside>

      <main class="main">
        <div class="search-bar">
          <input type="text" placeholder="Search mail" />
        </div>

        <section id="alarm1" class="alarm-page active">
          <table class="alarm-table">
            <thead>
              <tr>
                <th>발신자</th>
                <th>제목</th>
                <th>발생 시간</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Jenny Lim</td>
                <td>모델 성능 지표 분기별 감지</td>
                <td>2025.01.03 11:30</td>
              </tr>
              <tr>
                <td>Glass Heo</td>
                <td>실시간 데이터 드리프트 임계치 초과</td>
                <td>2025.02.28 14:20</td>
              </tr>
              <tr>
                <td>Garden Mun</td>
                <td>웹 접근 권한 외부 유출 위험 감지</td>
                <td>2025.03.06 20:30</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section id="alarm2" class="alarm-page">
          <table class="alarm-table">
            <thead>
              <tr>
                <th>발신자</th>
                <th>제목</th>
                <th>발생 시간</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Yul Ping</td>
                <td>새 모델 버전 배포 승인 요청</td>
                <td>2025.01.22 12:00</td>
              </tr>
              <tr>
                <td>Moon Ping</td>
                <td>훈련 데이터셋 이상치 0.2% 증가보고</td>
                <td>2025.06.06 05:20</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section id="alarm3" class="alarm-page">
          <table class="alarm-table">
            <thead>
              <tr>
                <th>발신자</th>
                <th>제목</th>
                <th>발생 시간</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Short</td>
                <td>시스템 보안 패치 및 업데이트 적용 완료</td>
                <td>2025.11.25 20:30</td>
              </tr>
              <tr>
                <td>Bambi</td>
                <td>훈련 데이터셋 이상치 필터링 및 재수집 완료</td>
                <td>2025.03.13 23:37</td>
              </tr>
            </tbody>
          </table>
        </section>
      </main>
    </div>

    <div id="alert-overlay" class="alert-overlay">
      <div class="alert-box">
        <h2>🔥 화재 감지 경고! 🔥</h2>
        <p id="alert-message">
          AI 서버에서 화재(FIRE)를 감지했습니다! 즉시 확인하세요!
        </p>
        <button onclick="closeAlert()">확인 및 경고 끄기</button>
      </div>
    </div>

    <script>
      (function () {
        const SERVER_HOST = "127.0.0.1";
        const SERVER_PORT = 9000;
        const WEBSOCKET_URL = `ws://${SERVER_HOST}:${SERVER_PORT}/ws/detections`;

        const alertOverlay = document.getElementById("alert-overlay");

        function startWebSocket() {
          const socket = new WebSocket(WEBSOCKET_URL);

          socket.onopen = function (e) {
            console.log("[WebSocket Open] FastAPI 서버에 연결되었습니다.");
          };

          socket.onmessage = function (event) {
            const detectionData = JSON.parse(event.data);
            console.log("🔥 실시간 감지 데이터 수신:", detectionData);

            const isFire =
              detectionData.is_fire_detected === true ||
              (detectionData.class_name &&
                detectionData.class_name.toUpperCase() === "FIRE");

            if (isFire) {
              showAlert(
                
              );
            }
          };

          socket.onclose = function (event) {
            if (!event.wasClean) {
              setTimeout(startWebSocket, 5000);
            }
          };

          socket.onerror = function (error) {
            console.error("[WebSocket Error]", error);
          };
        }

        function showAlert(message) {
          document.getElementById("alert-message").textContent = message;
          alertOverlay.style.display = "flex";
        }

        window.closeAlert = function () {
          alertOverlay.style.display = "none";
        };

        window.onload = function () {
          startWebSocket();
        };
      })();

      function showAlarm(num) {
        document
          .querySelectorAll(".sidebar-item")
          .forEach((it) => it.classList.remove("active"));
        event.currentTarget.classList.add("active");

        document
          .querySelectorAll(".alarm-page")
          .forEach((page) => page.classList.remove("active"));
        document.querySelector("#alarm" + num).classList.add("active");
      }
      (function () {
        const searchInput = document.querySelector(".search-bar input");
        const allTables = document.querySelectorAll(".alarm-table tbody");

        function filterAlarms() {
          const query = searchInput.value.trim().toLowerCase();

          if (query === "") {
            allTables.forEach((tbody) => {
              tbody.querySelectorAll("tr").forEach((row) => {
                row.style.display = "";
              });
            });
            return;
          }

          allTables.forEach((tbody) => {
            tbody.querySelectorAll("tr").forEach((row) => {
              const rowText = row.textContent.toLowerCase();

              if (rowText.includes(query)) {
                row.style.display = "";
              } else {
                row.style.display = "none";
              }
            });
          });
        }

        if (searchInput) {
          searchInput.addEventListener("keyup", filterAlarms);
          searchInput.addEventListener("input", filterAlarms);
        }
      })();
    </script>
  </body>
</html>
